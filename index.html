<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TimeValue Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
:root {
  --pastel-blue: #b8d4ff; --pastel-purple: #d4c5f9; --pastel-pink: #ffc8dd;
  --pastel-mint: #c7f0db; --pastel-peach: #ffd6a5; --pastel-lavender: #e7c6ff;
  --bg: #f5f3f0; --text: #2a2a2a; --text-light: #6b6b6b; --text-muted: #9a9a9a;
  --white: #ffffff; --border: #e0ddd8; --border-light: #eeebe6;
  --frame-border: rgba(42,42,42,0.12); --frame-light: rgba(42,42,42,0.06);
  --shadow-soft: 0 2px 20px rgba(0,0,0,0.04); --shadow-card: 0 4px 30px rgba(0,0,0,0.06);
  --font-body: 'Noto Sans JP', sans-serif; --font-heading: 'Noto Serif JP', serif;
}
html { font-size: 15px; }
body { font-family: var(--font-body); background: var(--bg); color: var(--text); line-height: 1.8; font-weight: 300; min-height: 100vh; overflow-x: hidden; }

/* OVERLAPPING FRAMES */
.frame-overlap { position: relative; }
.frame-overlap::before { content:''; position:absolute; top:-14px; left:-14px; right:20px; bottom:20px; border:1.5px solid var(--frame-border); pointer-events:none; z-index:0; }
.frame-overlap::after { content:''; position:absolute; top:14px; left:14px; right:-14px; bottom:-14px; border:1.5px solid var(--frame-light); pointer-events:none; z-index:0; }
.frame-overlap > * { position: relative; z-index: 1; }

.frame-triple { position: relative; }
.frame-triple::before { content:''; position:absolute; top:-18px; left:-10px; right:24px; bottom:24px; border:1.5px solid var(--frame-border); pointer-events:none; z-index:0; }
.frame-triple::after { content:''; position:absolute; top:10px; left:18px; right:-18px; bottom:-10px; border:1.5px solid var(--frame-light); pointer-events:none; z-index:0; }

.frame-diagonal { position: relative; }
.frame-diagonal::before { content:''; position:absolute; top:-20px; left:8px; right:-8px; bottom:12px; border:1.5px solid rgba(184,212,255,0.4); transform:rotate(0.5deg); pointer-events:none; z-index:0; }
.frame-diagonal::after { content:''; position:absolute; top:12px; left:-12px; right:16px; bottom:-16px; border:1.5px solid rgba(212,197,249,0.35); transform:rotate(-0.3deg); pointer-events:none; z-index:0; }

.frame-extra { position: relative; }
.frame-extra::before { content:''; position:absolute; top:-26px; left:-4px; right:30px; bottom:30px; border:1px solid rgba(255,200,221,0.3); pointer-events:none; }

/* LAYOUT */
.app-container { max-width: 1400px; margin: 0 auto; padding: 3rem 4rem; position: relative; }
@media (max-width: 1024px) { .app-container { padding: 2rem 1.5rem; } }

/* HEADER */
.app-header { display:grid; grid-template-columns:1fr auto; align-items:start; gap:3rem; margin-bottom:4rem; padding-bottom:3rem; border-bottom:1px solid var(--border-light); position:relative; }
.app-title-wrap { position: relative; }
.app-title { font-family:var(--font-heading); font-size:2.8rem; font-weight:700; letter-spacing:-0.02em; line-height:1.2; }
.app-title-sub { font-size:0.8rem; font-weight:300; color:var(--text-muted); letter-spacing:0.15em; text-transform:uppercase; margin-top:0.5rem; }

/* NAV */
.nav-tabs { display:flex; gap:0.25rem; background:var(--white); border:1px solid var(--border-light); border-radius:8px; padding:4px; box-shadow:var(--shadow-soft); }
.nav-tab { padding:0.6rem 1.4rem; font-family:var(--font-body); font-size:0.82rem; font-weight:400; color:var(--text-light); background:transparent; border:none; border-radius:6px; cursor:pointer; transition:all 0.25s; letter-spacing:0.02em; white-space:nowrap; }
.nav-tab:hover { color:var(--text); background:var(--bg); }
.nav-tab.active { color:var(--text); background:var(--bg); font-weight:500; box-shadow:0 1px 4px rgba(0,0,0,0.06); }

/* KPI */
.kpi-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:2.5rem; margin-bottom:4rem; position:relative; }
.kpi-card { position:relative; background:var(--white); padding:2.5rem 2rem; border:1px solid var(--border-light); box-shadow:var(--shadow-card); z-index:1; }
.kpi-label { font-size:0.72rem; font-weight:400; color:var(--text-muted); letter-spacing:0.12em; text-transform:uppercase; margin-bottom:1rem; }
.kpi-value { font-family:var(--font-heading); font-size:2.4rem; font-weight:700; line-height:1; }
.kpi-unit { font-family:var(--font-body); font-size:0.85rem; font-weight:300; color:var(--text-light); margin-left:0.3rem; }
.kpi-sub { font-size:0.78rem; color:var(--text-muted); margin-top:0.6rem; font-weight:300; }

/* PRINCIPLES */
.principles-section { position:relative; margin-bottom:4rem; padding:3rem 4rem; background:var(--white); border:1px solid var(--border-light); box-shadow:var(--shadow-soft); z-index:1; }
.principles-label { font-size:0.68rem; font-weight:400; color:var(--text-muted); letter-spacing:0.2em; text-transform:uppercase; margin-bottom:1.5rem; }
.principles-main { font-family:var(--font-heading); font-size:1.6rem; font-weight:600; line-height:1.6; margin-bottom:0.8rem; }
.principles-sub { font-size:0.88rem; color:var(--text-light); font-weight:300; line-height:1.8; white-space:pre-line; }

/* SECTION */
.section-header { display:flex; align-items:baseline; justify-content:space-between; margin-bottom:2rem; position:relative; }
.section-title { font-family:var(--font-heading); font-size:1.5rem; font-weight:600; position:relative; }
.section-title::after { content:''; position:absolute; bottom:-4px; left:0; width:30px; height:2px; background:var(--pastel-purple); }
.section-count { font-size:0.75rem; color:var(--text-muted); font-weight:300; }

/* TAGS */
.tag { display:inline-block; padding:0.2rem 0.8rem; font-size:0.7rem; font-weight:400; letter-spacing:0.05em; border-radius:2px; }
.tag-routine { background:var(--pastel-blue); color:#3a6db5; }
.tag-strategic { background:var(--pastel-purple); color:#6b5a9e; }
.tag-creative { background:var(--pastel-pink); color:#b5577a; }
.tag-admin { background:var(--pastel-peach); color:#b58040; }

/* BUTTONS */
.btn { font-family:var(--font-body); font-size:0.8rem; font-weight:400; padding:0.65rem 1.6rem; border:1px solid var(--border); background:var(--white); color:var(--text); cursor:pointer; transition:all 0.2s; letter-spacing:0.03em; }
.btn:hover { background:var(--text); color:var(--white); border-color:var(--text); }
.btn-primary { background:var(--text); color:var(--white); border-color:var(--text); }
.btn-primary:hover { background:#444; border-color:#444; }
.btn-sm { padding:0.4rem 1rem; font-size:0.75rem; }
.btn-xs { padding:0.25rem 0.7rem; font-size:0.7rem; }
.btn-ghost { border:none; background:transparent; color:var(--text-light); padding:0.4rem 0.8rem; }
.btn-ghost:hover { color:var(--text); background:var(--bg); }
.btn-timer-start { background:var(--pastel-mint); color:#3a7d5c; border:1px solid rgba(58,125,92,0.15); font-size:0.72rem; padding:0.3rem 0.9rem; font-weight:500; }
.btn-timer-start:hover { background:#a8e6c3; color:#2d6347; }
.btn-timer-stop { background:var(--pastel-pink); color:#b5577a; border:1px solid rgba(181,87,122,0.15); font-size:0.72rem; padding:0.3rem 0.9rem; font-weight:500; }
.btn-timer-stop:hover { background:#ffacc7; color:#9a3d62; }

/* FORMS */
.input, .select, .textarea { font-family:var(--font-body); font-size:0.88rem; font-weight:300; padding:0.7rem 1rem; border:1px solid var(--border); background:var(--white); color:var(--text); width:100%; transition:border-color 0.2s; outline:none; }
.input:focus, .select:focus, .textarea:focus { border-color:var(--text-muted); }
.textarea { resize:vertical; min-height:80px; line-height:1.7; }
.form-label { display:block; font-size:0.72rem; font-weight:400; color:var(--text-muted); letter-spacing:0.1em; text-transform:uppercase; margin-bottom:0.5rem; }
.form-group { margin-bottom: 1.2rem; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:1.2rem; }

/* WEEKDAY PICKER */
.weekday-picker { display:flex; gap:0.4rem; }
.weekday-btn { width:36px; height:36px; border:1px solid var(--border); background:var(--white); color:var(--text-light); font-size:0.72rem; font-weight:400; cursor:pointer; transition:all 0.15s; display:flex; align-items:center; justify-content:center; font-family:var(--font-body); }
.weekday-btn:hover { border-color:var(--text-muted); }
.weekday-btn.active { background:var(--text); color:var(--white); border-color:var(--text); font-weight:500; }

/* MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(42,42,42,0.3); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; z-index:1000; animation:fadeIn 0.2s; }
.modal { background:var(--white); width:90%; max-width:560px; max-height:85vh; overflow-y:auto; padding:3rem; position:relative; box-shadow:0 20px 60px rgba(0,0,0,0.12); animation:slideUp 0.25s; }
.modal::before { content:''; position:absolute; top:-12px; left:-12px; right:16px; bottom:16px; border:1.5px solid var(--frame-border); pointer-events:none; }
.modal::after { content:''; position:absolute; top:12px; left:12px; right:-12px; bottom:-12px; border:1px solid var(--frame-light); pointer-events:none; }
.modal-title { font-family:var(--font-heading); font-size:1.3rem; font-weight:600; margin-bottom:2rem; padding-bottom:1rem; border-bottom:1px solid var(--border-light); }
.modal-actions { display:flex; gap:0.8rem; justify-content:flex-end; margin-top:2rem; padding-top:1.5rem; border-top:1px solid var(--border-light); }

/* GRID */
.content-grid { display:grid; grid-template-columns:1fr 360px; gap:3rem; align-items:start; }
@media (max-width: 1024px) { .content-grid { grid-template-columns: 1fr; } .kpi-grid { grid-template-columns: 1fr; } }
.sidebar { position: relative; }
.sidebar::before { content:''; position:absolute; top:0; left:-1.5rem; width:1px; height:100%; background:var(--border-light); }

/* TASK ITEM */
.task-item { background:var(--white); border:1px solid var(--border-light); padding:1.2rem 1.6rem; margin-bottom:0.6rem; position:relative; transition:all 0.2s; box-shadow:var(--shadow-soft); }
.task-item:hover { box-shadow:var(--shadow-card); }
.task-item.completed { opacity:0.45; }
.task-item.completed .task-name { text-decoration:line-through; }
.task-item.is-running { border-left:3px solid #5a8f6e; }
.task-top-row { display:flex; align-items:center; justify-content:space-between; gap:1rem; }
.task-info { flex:1; min-width:0; }
.task-name { font-size:0.92rem; font-weight:500; margin-bottom:0.25rem; line-height:1.4; }
.task-meta { display:flex; align-items:center; gap:0.6rem; font-size:0.75rem; color:var(--text-muted); font-weight:300; flex-wrap:wrap; }
.task-right { display:flex; align-items:center; gap:0.5rem; flex-shrink:0; }
.task-time-badge { font-family:var(--font-heading); font-size:0.82rem; font-weight:600; white-space:nowrap; }
.task-bottom-row { display:flex; align-items:center; gap:0.4rem; margin-top:0.6rem; padding-top:0.5rem; border-top:1px solid var(--border-light); }

/* CLIENT */
.client-card { background:var(--white); border:1px solid var(--border-light); padding:2rem 2.2rem; margin-bottom:1rem; position:relative; box-shadow:var(--shadow-soft); cursor:grab; z-index:1; }
.client-card:active { cursor:grabbing; }
.client-card::before { content:''; position:absolute; top:0; left:0; width:3px; height:100%; }
.client-card:nth-child(4n+1)::before { background:var(--pastel-blue); }
.client-card:nth-child(4n+2)::before { background:var(--pastel-purple); }
.client-card:nth-child(4n+3)::before { background:var(--pastel-pink); }
.client-card:nth-child(4n)::before { background:var(--pastel-mint); }
.client-name { font-family:var(--font-heading); font-size:1.1rem; font-weight:600; margin-bottom:0.3rem; }
.client-revenue { font-size:0.82rem; color:var(--text-light); font-weight:300; }

/* TIMER */
.timer-display { font-family:var(--font-heading); font-size:2rem; font-weight:700; letter-spacing:0.05em; text-align:center; padding:1rem 0; }
.timer-running { color:#5a8f6e; }
.timer-controls { display:flex; gap:0.5rem; justify-content:center; }

/* REPORT */
.report-filters { display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; align-items:end; }
.report-table { width:100%; border-collapse:collapse; }
.report-table th { font-size:0.72rem; font-weight:500; color:var(--text-muted); letter-spacing:0.1em; text-transform:uppercase; text-align:left; padding:0.8rem 1rem; border-bottom:2px solid var(--border); }
.report-table td { font-size:0.88rem; font-weight:300; padding:0.8rem 1rem; border-bottom:1px solid var(--border-light); }
.report-table tr:hover td { background:rgba(0,0,0,0.01); }

/* AI CHAT */
.ai-chat-container { background:var(--white); border:1px solid var(--border-light); box-shadow:var(--shadow-card); padding:2rem; position:relative; z-index:1; }
.chat-messages { min-height:200px; max-height:400px; overflow-y:auto; margin-bottom:1rem; padding:1rem 0; }
.chat-bubble { padding:1rem 1.4rem; margin-bottom:0.8rem; font-size:0.88rem; line-height:1.7; font-weight:300; max-width:85%; white-space:pre-line; }
.chat-bubble-user { background:var(--bg); border:1px solid var(--border-light); margin-left:auto; }
.chat-bubble-ai { background:var(--pastel-lavender); opacity:0.9; border:1px solid rgba(0,0,0,0.04); }
.chat-input-row { display:flex; gap:0.5rem; }

/* DATA */
.data-section { display:grid; grid-template-columns:1fr 1fr; gap:2rem; margin-top:2rem; }
.data-card { background:var(--white); border:1px solid var(--border-light); padding:2.5rem; text-align:center; box-shadow:var(--shadow-soft); position:relative; z-index:1; }
.data-card-title { font-family:var(--font-heading); font-size:1.1rem; font-weight:600; margin-bottom:0.6rem; }
.data-card-desc { font-size:0.82rem; color:var(--text-muted); font-weight:300; margin-bottom:1.5rem; }

@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes slideUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
.fade-in { animation: fadeIn 0.4s ease; }

::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

.toast { position:fixed; bottom:2rem; right:2rem; background:var(--text); color:var(--white); padding:0.8rem 1.6rem; font-size:0.82rem; font-weight:400; z-index:2000; animation:slideUp 0.3s; box-shadow:0 4px 20px rgba(0,0,0,0.15); }
.app-footer { margin-top:4rem; padding-top:2rem; border-top:1px solid var(--border-light); text-align:center; font-size:0.72rem; color:var(--text-muted); font-weight:300; letter-spacing:0.08em; }
</style>
</head>
<body>
<div style="position:fixed;top:4%;right:2%;width:100px;height:100px;border:1px solid rgba(255,200,221,0.25);transform:rotate(12deg);pointer-events:none;z-index:0"></div>
<div style="position:fixed;top:6%;right:3.5%;width:70px;height:70px;border:1px solid rgba(184,212,255,0.2);transform:rotate(-5deg);pointer-events:none;z-index:0"></div>
<div style="position:fixed;bottom:8%;left:1.5%;width:80px;height:80px;border:1px solid rgba(212,197,249,0.2);transform:rotate(-18deg);pointer-events:none;z-index:0"></div>
<div style="position:fixed;bottom:12%;left:3%;width:50px;height:50px;border:1px solid rgba(199,240,219,0.25);transform:rotate(25deg);pointer-events:none;z-index:0"></div>
<div style="position:fixed;top:35%;left:0.8%;width:1px;height:140px;background:var(--border);opacity:0.25;pointer-events:none;z-index:0"></div>
<div style="position:fixed;top:15%;right:1%;width:1px;height:90px;background:var(--border);opacity:0.2;pointer-events:none;z-index:0"></div>
<div style="position:fixed;top:55%;right:0.5%;width:35px;height:2px;background:rgba(255,214,165,0.4);pointer-events:none;z-index:0"></div>
<div style="position:fixed;top:25%;left:0.5%;width:25px;height:2px;background:rgba(231,198,255,0.35);pointer-events:none;z-index:0"></div>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;
const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
const formatTime = (minutes) => { if (!minutes && minutes !== 0) return '0m'; const h = Math.floor(minutes / 60); const m = Math.round(minutes % 60); return h > 0 ? h+'h '+m.toString().padStart(2,'0')+'m' : m+'m'; };
const formatTimerDisplay = (seconds) => { const h = Math.floor(seconds / 3600); const m = Math.floor((seconds % 3600) / 60); const s = seconds % 60; return h.toString().padStart(2,'0')+':'+m.toString().padStart(2,'0')+':'+s.toString().padStart(2,'0'); };
const formatCurrency = (amount) => new Intl.NumberFormat('ja-JP', { style:'currency', currency:'JPY', maximumFractionDigits:0 }).format(amount);
const getMonthRange = (date = new Date()) => { const start = new Date(date.getFullYear(), date.getMonth(), 1); const end = new Date(date.getFullYear(), date.getMonth()+1, 0, 23, 59, 59); return { start, end }; };
const loadData = (key, fallback) => { try { const d = localStorage.getItem(key); return d ? JSON.parse(d) : fallback; } catch { return fallback; } };
const saveData = (key, data) => { try { localStorage.setItem(key, JSON.stringify(data)); } catch {} };

const CATEGORIES = [
  { id:'routine', label:'Routine', color:'tag-routine' },
  { id:'strategic', label:'Strategic', color:'tag-strategic' },
  { id:'creative', label:'Creative', color:'tag-creative' },
  { id:'admin', label:'Admin', color:'tag-admin' },
];
const REPEAT_OPTIONS = [
  { id:'none', label:'なし' }, { id:'daily', label:'毎日' },
  { id:'weekly', label:'毎週' }, { id:'monthly', label:'毎月' },
];
const WEEKDAYS = [
  { id:0, label:'日' }, { id:1, label:'月' }, { id:2, label:'火' },
  { id:3, label:'水' }, { id:4, label:'木' }, { id:5, label:'金' }, { id:6, label:'土' },
];

function migrateImportData(raw) {
  const result = {};
  if (raw.clients) {
    result.clients = raw.clients.map(c => ({
      id: c.client_id || c.id || generateId(),
      name: c.name || '',
      monthlyRevenue: c.monthly_fee ?? c.monthlyRevenue ?? 0,
    }));
  }
  if (raw.tasks) {
    result.tasks = raw.tasks.map(t => {
      let repeat = 'none';
      if (typeof t.repeat === 'boolean') {
        repeat = t.repeat ? (t.repeatType || 'daily') : 'none';
      } else if (typeof t.repeat === 'string') {
        repeat = t.repeat;
      }
      return {
        id: t.task_id || t.id || generateId(),
        name: t.title || t.name || '',
        clientId: t.client_id || t.clientId || '',
        dueDate: t.due_date || t.dueDate || null,
        dueTime: t.due_time || t.dueTime || null,
        category: t.category || 'routine',
        repeat,
        repeatDays: t.repeatDays || [],
        completed: t.completed || false,
        isActive: t.is_active ?? t.isActive ?? !t.completed,
        lastCompleted: t.last_completed || t.lastCompleted || null,
        notes: t.notes || '',
        createdAt: t.createdAt || new Date().toISOString(),
      };
    });
  }
  if (raw.timeLogs) {
    result.timeLogs = raw.timeLogs.map(l => ({
      id: l.time_log_id || l.id || generateId(),
      taskId: l.task_id || l.taskId || '',
      startTime: l.start_ts ? new Date(l.start_ts).toISOString() : (l.startTime || new Date().toISOString()),
      endTime: l.end_ts ? new Date(l.end_ts).toISOString() : (l.endTime || new Date().toISOString()),
      duration: l.duration_sec ? Math.round(l.duration_sec / 60) : (l.duration || 0),
    }));
  }
  if (raw.principles) {
    const p = raw.principles;
    result.principles = {
      main: p.motto || p.main || '',
      sub: (p.subCopy || p.sub || '') + (p.principles ? '\n' + p.principles : ''),
    };
  }
  if (raw.clientOrder) result.clientOrder = raw.clientOrder;
  if (raw.runningState) {
    const rs = raw.runningState;
    result.runningState = rs.task_id ? { taskId: rs.task_id, startTime: rs.start_ts ? new Date(rs.start_ts).toISOString() : null } : null;
  }
  return result;
}

function App() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [clients, setClients] = useState(() => loadData('timevalue-clients', []));
  const [tasks, setTasks] = useState(() => loadData('timevalue-tasks', []));
  const [timeLogs, setTimeLogs] = useState(() => loadData('timevalue-timeLogs', []));
  const [principles, setPrinciples] = useState(() => loadData('timevalue-principles', { main:'時間は最も貴重な資産である', sub:'一つ一つの仕事に真摯に向き合い、価値ある時間を積み重ねる' }));
  const [clientOrder, setClientOrder] = useState(() => loadData('timevalue-clientOrder', []));
  const [runningState, setRunningState] = useState(() => loadData('timevalue-runningState', null));
  const [toast, setToast] = useState(null);

  useEffect(() => saveData('timevalue-clients', clients), [clients]);
  useEffect(() => saveData('timevalue-tasks', tasks), [tasks]);
  useEffect(() => saveData('timevalue-timeLogs', timeLogs), [timeLogs]);
  useEffect(() => saveData('timevalue-principles', principles), [principles]);
  useEffect(() => saveData('timevalue-clientOrder', clientOrder), [clientOrder]);
  useEffect(() => saveData('timevalue-runningState', runningState), [runningState]);

  const showToast = useCallback((msg) => { setToast(msg); setTimeout(() => setToast(null), 2500); }, []);

  const kpi = useMemo(() => {
    const { start, end } = getMonthRange();
    const ml = timeLogs.filter(l => { const d = new Date(l.startTime); return d >= start && d <= end; });
    const totalMinutes = ml.reduce((s, l) => s + (l.duration || 0), 0);
    const totalRevenue = clients.reduce((s, c) => s + (c.monthlyRevenue || 0), 0);
    const hourlyRate = totalMinutes > 0 ? (totalRevenue / (totalMinutes / 60)) : 0;
    return { totalMinutes, totalRevenue, hourlyRate };
  }, [timeLogs, clients]);

  const getClientName = useCallback((cid) => { const c = clients.find(cl => cl.id === cid); return c ? c.name : '未分類'; }, [clients]);
  const orderedClients = useMemo(() => {
    if (!clientOrder.length) return clients;
    const o = []; clientOrder.forEach(id => { const c = clients.find(cl => cl.id === id); if (c) o.push(c); });
    clients.forEach(c => { if (!o.find(x => x.id === c.id)) o.push(c); });
    return o;
  }, [clients, clientOrder]);
  const getTaskTime = useCallback((tid) => timeLogs.filter(l => l.taskId === tid).reduce((s, l) => s + (l.duration || 0), 0), [timeLogs]);
  const startTimer = useCallback((tid) => { if (runningState) { showToast('他のタイマーが実行中です'); return; } setRunningState({ taskId: tid, startTime: new Date().toISOString() }); showToast('タイマー開始'); }, [runningState, showToast]);
  const stopTimer = useCallback(() => {
    if (!runningState) return;
    const dur = Math.round((new Date() - new Date(runningState.startTime)) / 60000);
    if (dur > 0) { setTimeLogs(prev => [...prev, { id: generateId(), taskId: runningState.taskId, startTime: runningState.startTime, endTime: new Date().toISOString(), duration: dur }]); }
    setRunningState(null); showToast('タイマー停止');
  }, [runningState, showToast]);

  const tabs = [{ id:'dashboard', label:'Dashboard' }, { id:'clients', label:'Clients' }, { id:'report', label:'Report' }, { id:'data', label:'Data' }];

  return (
    <div className="app-container fade-in">
      <header className="app-header">
        <div className="app-title-wrap">
          <div style={{position:'absolute',top:'-1.2rem',left:'-2.2rem',width:'65px',height:'65px',border:'1px solid var(--pastel-purple)',opacity:0.4,transform:'rotate(12deg)',pointerEvents:'none'}}></div>
          <div style={{position:'absolute',top:'0.2rem',left:'-1.2rem',width:'42px',height:'42px',border:'1px solid var(--pastel-pink)',opacity:0.35,transform:'rotate(-5deg)',pointerEvents:'none'}}></div>
          <div style={{position:'absolute',top:'-0.5rem',left:'-3rem',width:'28px',height:'2px',background:'var(--pastel-blue)',opacity:0.5,pointerEvents:'none'}}></div>
          <h1 className="app-title">TimeValue Tracker</h1>
          <p className="app-title-sub">Client Work Management</p>
        </div>
        <nav className="nav-tabs">
          {tabs.map(t => <button key={t.id} className={'nav-tab'+(activeTab===t.id?' active':'')} onClick={()=>setActiveTab(t.id)}>{t.label}</button>)}
        </nav>
      </header>
      {activeTab==='dashboard' && <DashboardView kpi={kpi} principles={principles} setPrinciples={setPrinciples} tasks={tasks} setTasks={setTasks} clients={clients} timeLogs={timeLogs} setTimeLogs={setTimeLogs} runningState={runningState} startTimer={startTimer} stopTimer={stopTimer} getClientName={getClientName} getTaskTime={getTaskTime} showToast={showToast} />}
      {activeTab==='clients' && <ClientsView clients={clients} setClients={setClients} orderedClients={orderedClients} clientOrder={clientOrder} setClientOrder={setClientOrder} tasks={tasks} timeLogs={timeLogs} showToast={showToast} />}
      {activeTab==='report' && <ReportView tasks={tasks} clients={clients} timeLogs={timeLogs} getClientName={getClientName} />}
      {activeTab==='data' && <DataView clients={clients} setClients={setClients} tasks={tasks} setTasks={setTasks} timeLogs={timeLogs} setTimeLogs={setTimeLogs} principles={principles} setPrinciples={setPrinciples} clientOrder={clientOrder} setClientOrder={setClientOrder} runningState={runningState} setRunningState={setRunningState} showToast={showToast} />}
      <footer className="app-footer">TimeValue Tracker v12</footer>
      {toast && <div className="toast">{toast}</div>}
    </div>
  );
}

function DashboardView({ kpi, principles, setPrinciples, tasks, setTasks, clients, timeLogs, setTimeLogs, runningState, startTimer, stopTimer, getClientName, getTaskTime, showToast }) {
  const [editingP, setEditingP] = useState(false);
  const [pForm, setPForm] = useState(principles);
  const [showTaskModal, setShowTaskModal] = useState(false);
  const [editTask, setEditTask] = useState(null);
  const [showAddTime, setShowAddTime] = useState(null);
  const [addTimeMins, setAddTimeMins] = useState('');
  const [taskFilter, setTaskFilter] = useState('active');

  const filteredTasks = useMemo(() => {
    if (taskFilter==='active') return tasks.filter(t=>!t.completed);
    if (taskFilter==='completed') return tasks.filter(t=>t.completed);
    return tasks;
  }, [tasks, taskFilter]);

  const saveP = () => { setPrinciples(pForm); setEditingP(false); showToast('座右の銘を更新しました'); };
  const handleSaveTask = (d) => {
    if (editTask) { setTasks(prev=>prev.map(t=>t.id===editTask.id?{...t,...d}:t)); showToast('タスクを更新しました'); }
    else { setTasks(prev=>[...prev,{id:generateId(),...d,completed:false,createdAt:new Date().toISOString()}]); showToast('タスクを作成しました'); }
    setShowTaskModal(false); setEditTask(null);
  };
  const handleDel = (id) => { if(confirm('このタスクを削除しますか？')){ setTasks(prev=>prev.filter(t=>t.id!==id)); showToast('タスクを削除しました'); } };
  const handleComp = (id) => { setTasks(prev=>prev.map(t=>t.id===id?{...t,completed:true,completedAt:new Date().toISOString()}:t)); showToast('タスクを完了しました'); };
  const handleAddT = (tid) => {
    const m = parseInt(addTimeMins); if(!m||m<=0)return;
    const now=new Date();
    setTimeLogs(prev=>[...prev,{id:generateId(),taskId:tid,startTime:new Date(now-m*60000).toISOString(),endTime:now.toISOString(),duration:m,manual:true}]);
    setShowAddTime(null); setAddTimeMins(''); showToast(m+'分を追加しました');
  };

  return (
    <div className="fade-in">
      <div className="frame-extra"><div className="kpi-grid frame-overlap">
        <div className="kpi-card" style={{borderTop:'3px solid var(--pastel-blue)'}}><div className="kpi-label">Today's Work</div><div className="kpi-value">{formatTime(kpi.totalMinutes)}</div><div className="kpi-sub">今月の作業時間</div></div>
        <div className="kpi-card" style={{borderTop:'3px solid var(--pastel-purple)'}}><div className="kpi-label">Monthly Revenue</div><div className="kpi-value">{formatCurrency(kpi.totalRevenue)}</div><div className="kpi-sub">今月の総売上</div></div>
        <div className="kpi-card" style={{borderTop:'3px solid var(--pastel-mint)'}}><div className="kpi-label">Hourly Rate</div><div className="kpi-value">{formatCurrency(Math.round(kpi.hourlyRate))}<span className="kpi-unit">/h</span></div><div className="kpi-sub">実質時給</div></div>
      </div></div>

      <div className="frame-diagonal" style={{marginBottom:'4rem'}}>
        <div className="principles-section">
          <div style={{position:'absolute',top:'-8px',right:'-8px',width:'30px',height:'30px',border:'1px solid var(--pastel-lavender)',opacity:0.6,transform:'rotate(20deg)',pointerEvents:'none',zIndex:2}}></div>
          <div style={{position:'absolute',bottom:'-10px',left:'40px',width:'20px',height:'20px',border:'1px solid var(--pastel-peach)',opacity:0.4,transform:'rotate(-15deg)',pointerEvents:'none',zIndex:2}}></div>
          <div className="principles-label">Principles</div>
          {editingP ? (
            <div>
              <div className="form-group"><input className="input" value={pForm.main} onChange={e=>setPForm({...pForm,main:e.target.value})} /></div>
              <div className="form-group"><textarea className="textarea" value={pForm.sub} onChange={e=>setPForm({...pForm,sub:e.target.value})} rows={4} /></div>
              <div style={{display:'flex',gap:'0.5rem'}}><button className="btn btn-primary btn-sm" onClick={saveP}>保存</button><button className="btn btn-sm" onClick={()=>setEditingP(false)}>キャンセル</button></div>
            </div>
          ) : (
            <div onClick={()=>{setEditingP(true);setPForm(principles);}} style={{cursor:'pointer'}}>
              <div className="principles-main">{principles.main}</div>
              <div className="principles-sub">{principles.sub}</div>
            </div>
          )}
        </div>
      </div>

      <div className="content-grid">
        <div>
          <div className="section-header">
            <h2 className="section-title">Tasks</h2>
            <div style={{display:'flex',gap:'0.5rem',alignItems:'center'}}>
              <select className="select" style={{width:'auto',padding:'0.4rem 0.8rem',fontSize:'0.78rem'}} value={taskFilter} onChange={e=>setTaskFilter(e.target.value)}>
                <option value="active">アクティブ</option><option value="completed">完了済み</option><option value="all">すべて</option>
              </select>
              <button className="btn btn-primary btn-sm" onClick={()=>{setEditTask(null);setShowTaskModal(true);}}>新規タスク</button>
            </div>
          </div>
          {filteredTasks.length===0 ? (
            <div className="task-item" style={{textAlign:'center',color:'var(--text-muted)',padding:'2.5rem'}}>タスクがありません</div>
          ) : filteredTasks.map(task => {
            const isRun = runningState && runningState.taskId === task.id;
            const cat = CATEGORIES.find(c => c.id === task.category);
            const totalT = getTaskTime(task.id);
            const repLabel = REPEAT_OPTIONS.find(r => r.id === task.repeat)?.label;
            const dayLabels = (task.repeatDays||[]).map(d => WEEKDAYS.find(w=>w.id===d)?.label).filter(Boolean).join(' ');
            return (
              <div key={task.id} className={'task-item'+(task.completed?' completed':'')+(isRun?' is-running':'')}>
                <div className="task-top-row">
                  <div className="task-info">
                    <div className="task-name">{task.name}</div>
                    <div className="task-meta">
                      <span>{getClientName(task.clientId)}</span>
                      {cat && <span className={'tag '+cat.color}>{cat.label}</span>}
                      {task.repeat && task.repeat !== 'none' && <span style={{fontSize:'0.7rem'}}>{repLabel}{dayLabels?'('+dayLabels+')':''}</span>}
                    </div>
                  </div>
                  <div className="task-right">
                    <span className="task-time-badge">{formatTime(totalT)}</span>
                    {!task.completed && (isRun ?
                      <button className="btn btn-timer-stop" onClick={stopTimer}>停止</button> :
                      <button className="btn btn-timer-start" onClick={()=>startTimer(task.id)}>開始</button>
                    )}
                  </div>
                </div>
                {!task.completed && (
                  <div className="task-bottom-row">
                    <button className="btn btn-xs btn-ghost" onClick={()=>{setEditTask(task);setShowTaskModal(true);}}>編集</button>
                    <button className="btn btn-xs btn-ghost" onClick={()=>handleComp(task.id)}>完了</button>
                    {showAddTime===task.id ? (
                      <div style={{display:'flex',gap:'0.3rem',alignItems:'center',marginLeft:'auto'}}>
                        <input className="input" style={{width:'65px',padding:'0.25rem 0.5rem',fontSize:'0.78rem'}} type="number" placeholder="分" value={addTimeMins} onChange={e=>setAddTimeMins(e.target.value)} />
                        <button className="btn btn-xs" onClick={()=>handleAddT(task.id)}>追加</button>
                        <button className="btn btn-xs btn-ghost" onClick={()=>setShowAddTime(null)}>取消</button>
                      </div>
                    ) : <button className="btn btn-xs btn-ghost" style={{marginLeft:'auto'}} onClick={()=>setShowAddTime(task.id)}>時間追加</button>}
                    <button className="btn btn-xs btn-ghost" style={{color:'#c77'}} onClick={()=>handleDel(task.id)}>削除</button>
                  </div>
                )}
                {task.completed && <div className="task-bottom-row"><button className="btn btn-xs btn-ghost" style={{color:'#c77'}} onClick={()=>handleDel(task.id)}>削除</button></div>}
              </div>
            );
          })}
        </div>
        <div className="sidebar">
          <div className="frame-triple" style={{marginBottom:'2rem'}}>
            <TimerWidget runningState={runningState} stopTimer={stopTimer} tasks={tasks} getClientName={getClientName} />
          </div>
        </div>
      </div>

      {showTaskModal && <TaskModal task={editTask} clients={clients} onSave={handleSaveTask} onClose={()=>{setShowTaskModal(false);setEditTask(null);}} />}
    </div>
  );
}

function TimerWidget({ runningState, stopTimer, tasks, getClientName }) {
  const [elapsed, setElapsed] = useState(0);
  const ref = useRef(null);
  useEffect(() => {
    if (runningState?.startTime) {
      const u = () => setElapsed(Math.floor((Date.now()-new Date(runningState.startTime).getTime())/1000));
      u(); ref.current = setInterval(u, 1000);
      return () => clearInterval(ref.current);
    } else { setElapsed(0); if(ref.current)clearInterval(ref.current); }
  }, [runningState]);
  const rt = runningState ? tasks.find(t=>t.id===runningState.taskId) : null;
  return (
    <div className="ai-chat-container" style={{padding:'2.5rem 2rem'}}>
      <div className="principles-label" style={{marginBottom:'1.5rem'}}>Timer</div>
      {rt ? (<div>
        <div style={{fontSize:'0.88rem',fontWeight:500,marginBottom:'0.3rem'}}>{rt.name}</div>
        <div style={{fontSize:'0.75rem',color:'var(--text-muted)',marginBottom:'1rem'}}>{getClientName(rt.clientId)}</div>
        <div className="timer-display timer-running">{formatTimerDisplay(elapsed)}</div>
        <div className="timer-controls"><button className="btn btn-primary" onClick={stopTimer}>停止</button></div>
      </div>) : (<div style={{textAlign:'center',color:'var(--text-muted)',fontSize:'0.85rem',padding:'2rem 0'}}>
        <div className="timer-display" style={{opacity:0.3}}>00:00:00</div>
        <div style={{marginTop:'0.5rem'}}>タスクから開始ボタンを押してください</div>
      </div>)}
    </div>
  );
}

function TaskModal({ task, clients, onSave, onClose }) {
  const [form, setForm] = useState({
    name:task?.name||'', clientId:task?.clientId||(clients[0]?.id||''), category:task?.category||'routine',
    repeat:task?.repeat||'none', repeatDays:task?.repeatDays||[], dueDate:task?.dueDate||'', dueTime:task?.dueTime||'', notes:task?.notes||'',
  });
  const toggleDay = (d) => setForm(p=>({...p,repeatDays:p.repeatDays.includes(d)?p.repeatDays.filter(x=>x!==d):[...p.repeatDays,d].sort()}));
  return (
    <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e=>e.stopPropagation()}>
      <div className="modal-title">{task?'タスクを編集':'新規タスク'}</div>
      <div className="form-group"><label className="form-label">タスク名</label><input className="input" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} autoFocus /></div>
      <div className="form-row">
        <div className="form-group"><label className="form-label">取引先</label><select className="select" value={form.clientId} onChange={e=>setForm({...form,clientId:e.target.value})}><option value="">未分類</option>{clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
        <div className="form-group"><label className="form-label">カテゴリー</label><select className="select" value={form.category} onChange={e=>setForm({...form,category:e.target.value})}>{CATEGORIES.map(c=><option key={c.id} value={c.id}>{c.label}</option>)}</select></div>
      </div>
      <div className="form-row">
        <div className="form-group"><label className="form-label">期日</label><input className="input" type="date" value={form.dueDate} onChange={e=>setForm({...form,dueDate:e.target.value})} /></div>
        <div className="form-group"><label className="form-label">時刻</label><input className="input" type="time" value={form.dueTime} onChange={e=>setForm({...form,dueTime:e.target.value})} /></div>
      </div>
      <div className="form-group"><label className="form-label">繰り返し</label><select className="select" value={form.repeat} onChange={e=>setForm({...form,repeat:e.target.value})}>{REPEAT_OPTIONS.map(r=><option key={r.id} value={r.id}>{r.label}</option>)}</select></div>
      {form.repeat==='weekly' && <div className="form-group"><label className="form-label">曜日選択</label><div className="weekday-picker">{WEEKDAYS.map(w=><button key={w.id} type="button" className={'weekday-btn'+(form.repeatDays.includes(w.id)?' active':'')} onClick={()=>toggleDay(w.id)}>{w.label}</button>)}</div></div>}
      <div className="form-group"><label className="form-label">メモ</label><textarea className="textarea" value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})} /></div>
      <div className="modal-actions"><button className="btn" onClick={onClose}>キャンセル</button><button className="btn btn-primary" onClick={()=>{if(form.name.trim())onSave(form);}}>{task?'更新':'作成'}</button></div>
    </div></div>
  );
}

function ClientsView({ clients, setClients, orderedClients, clientOrder, setClientOrder, tasks, timeLogs, showToast }) {
  const [showModal, setShowModal] = useState(false);
  const [editClient, setEditClient] = useState(null);
  const di = useRef(null); const doi = useRef(null);
  const handleSave = (d) => {
    if (editClient) { setClients(prev=>prev.map(c=>c.id===editClient.id?{...c,...d}:c)); showToast('取引先を更新しました'); }
    else { const nc={id:generateId(),...d}; setClients(prev=>[...prev,nc]); setClientOrder(prev=>[...prev,nc.id]); showToast('取引先を追加しました'); }
    setShowModal(false); setEditClient(null);
  };
  const handleDel = (id) => { if(confirm('この取引先を削除しますか？')){ setClients(prev=>prev.filter(c=>c.id!==id)); setClientOrder(prev=>prev.filter(i=>i!==id)); showToast('取引先を削除しました'); } };
  const getCS = (cid) => {
    const {start,end}=getMonthRange();
    const ct=tasks.filter(t=>t.clientId===cid);
    const cl=timeLogs.filter(l=>{const t=tasks.find(tt=>tt.id===l.taskId);return t&&t.clientId===cid;});
    const ml=cl.filter(l=>{const d=new Date(l.startTime);return d>=start&&d<=end;});
    return{taskCount:ct.length,totalMinutes:ml.reduce((s,l)=>s+(l.duration||0),0)};
  };
  return (
    <div className="fade-in">
      <div className="section-header"><h2 className="section-title">Clients</h2><button className="btn btn-primary btn-sm" onClick={()=>{setEditClient(null);setShowModal(true);}}>新規取引先</button></div>
      <div className="frame-overlap" style={{marginTop:'1rem'}}>
        {orderedClients.length===0 ? <div className="client-card" style={{textAlign:'center',color:'var(--text-muted)',padding:'3rem'}}>取引先がありません</div> :
        orderedClients.map((c,idx) => {
          const s=getCS(c.id);
          return (<div key={c.id} className="client-card" draggable onDragStart={()=>{di.current=idx;}} onDragEnter={()=>{doi.current=idx;}} onDragEnd={()=>{const it=[...orderedClients];const dr=it[di.current];it.splice(di.current,1);it.splice(doi.current,0,dr);setClientOrder(it.map(x=>x.id));di.current=null;doi.current=null;}} onDragOver={e=>e.preventDefault()}>
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'start'}}>
              <div><div className="client-name">{c.name}</div><div className="client-revenue">{formatCurrency(c.monthlyRevenue||0)} / month</div></div>
              <div style={{display:'flex',gap:'0.3rem'}}><button className="btn btn-sm btn-ghost" onClick={()=>{setEditClient(c);setShowModal(true);}}>編集</button><button className="btn btn-sm btn-ghost" style={{color:'#c77'}} onClick={()=>handleDel(c.id)}>削除</button></div>
            </div>
            <div className="task-meta" style={{marginTop:'0.5rem'}}><span>{s.taskCount} tasks</span><span>今月: {formatTime(s.totalMinutes)}</span></div>
          </div>);
        })}
      </div>
      {showModal && <div className="modal-overlay" onClick={()=>{setShowModal(false);setEditClient(null);}}><div className="modal" onClick={e=>e.stopPropagation()}>
        <ClientForm client={editClient} onSave={handleSave} onClose={()=>{setShowModal(false);setEditClient(null);}} />
      </div></div>}
    </div>
  );
}

function ClientForm({ client, onSave, onClose }) {
  const [f, sF] = useState({name:client?.name||'',monthlyRevenue:client?.monthlyRevenue||0});
  return (<>
    <div className="modal-title">{client?'取引先を編集':'新規取引先'}</div>
    <div className="form-group"><label className="form-label">取引先名</label><input className="input" value={f.name} onChange={e=>sF({...f,name:e.target.value})} autoFocus /></div>
    <div className="form-group"><label className="form-label">月額報酬（円）</label><input className="input" type="number" value={f.monthlyRevenue} onChange={e=>sF({...f,monthlyRevenue:parseInt(e.target.value)||0})} /></div>
    <div className="modal-actions"><button className="btn" onClick={onClose}>キャンセル</button><button className="btn btn-primary" onClick={()=>{if(f.name.trim())onSave(f);}}>{client?'更新':'追加'}</button></div>
  </>);
}

function ReportView({ tasks, clients, timeLogs, getClientName }) {
  const [period, setPeriod] = useState('month');
  const [cf, setCf] = useState('all');
  const [chatMsgs, setChatMsgs] = useState([]);
  const [chatIn, setChatIn] = useState('');
  const [chatLoad, setChatLoad] = useState(false);

  const fLogs = useMemo(() => {
    let logs=[...timeLogs]; const now=new Date();
    if(period==='week'){const wa=new Date(now-7*24*60*60*1000);logs=logs.filter(l=>new Date(l.startTime)>=wa);}
    else if(period==='month'){const{start,end}=getMonthRange();logs=logs.filter(l=>{const d=new Date(l.startTime);return d>=start&&d<=end;});}
    if(cf!=='all')logs=logs.filter(l=>{const t=tasks.find(tt=>tt.id===l.taskId);return t&&t.clientId===cf;});
    return logs;
  }, [timeLogs, tasks, period, cf]);

  const tSum = useMemo(() => {
    const m={};
    fLogs.forEach(l=>{const t=tasks.find(tt=>tt.id===l.taskId);if(!t)return;if(!m[t.id])m[t.id]={taskId:t.id,name:t.name,clientName:getClientName(t.clientId),category:t.category,totalMinutes:0,lastLog:l.startTime};m[t.id].totalMinutes+=l.duration||0;if(new Date(l.startTime)>new Date(m[t.id].lastLog))m[t.id].lastLog=l.startTime;});
    return Object.values(m).sort((a,b)=>new Date(b.lastLog)-new Date(a.lastLog));
  }, [fLogs, tasks, getClientName]);

  const totalMin = fLogs.reduce((s,l)=>s+(l.duration||0),0);

  const sendChat = async () => {
    if(!chatIn.trim()||chatLoad)return;
    const um=chatIn.trim(); setChatIn(''); setChatMsgs(p=>[...p,{role:'user',content:um}]); setChatLoad(true);
    const ctx=`作業レポートデータ:\n- 期間: ${period==='week'?'直近1週間':period==='month'?'今月':'全期間'}\n- 総作業時間: ${formatTime(totalMin)}\n- タスク数: ${tSum.length}\n${tSum.map(t=>'  - '+t.name+' ('+t.clientName+'): '+formatTime(t.totalMinutes)).join('\n')}`;
    try {
      const r = await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1500,system:'あなたはプロフェッショナルなワークコーチです。ユーザーの作業データを分析し、内省を促す質問や洞察を提供してください。日本語で回答してください。\n\n'+ctx,messages:chatMsgs.concat([{role:'user',content:um}]).map(m=>({role:m.role,content:m.content}))})});
      const d=await r.json(); const at=d.content?.map(c=>c.text||'').join('')||'エラーが発生しました';
      setChatMsgs(p=>[...p,{role:'assistant',content:at}]);
    } catch { setChatMsgs(p=>[...p,{role:'assistant',content:'API接続エラーが発生しました。'}]); }
    setChatLoad(false);
  };

  return (
    <div className="fade-in">
      <div className="section-header"><h2 className="section-title">Report</h2><span className="section-count">Total: {formatTime(totalMin)}</span></div>
      <div className="report-filters">
        <div className="form-group" style={{marginBottom:0}}><label className="form-label">期間</label><select className="select" style={{width:'auto'}} value={period} onChange={e=>setPeriod(e.target.value)}><option value="week">直近1週間</option><option value="month">今月</option><option value="all">全期間</option></select></div>
        <div className="form-group" style={{marginBottom:0}}><label className="form-label">取引先</label><select className="select" style={{width:'auto'}} value={cf} onChange={e=>setCf(e.target.value)}><option value="all">すべて</option>{clients.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
      </div>
      <div className="frame-overlap" style={{marginBottom:'3rem'}}>
        {tSum.length>0 ? (
          <div style={{overflowX:'auto',background:'var(--white)',border:'1px solid var(--border-light)',padding:'1rem',boxShadow:'var(--shadow-soft)'}}>
            <table className="report-table"><thead><tr><th>タスク</th><th>取引先</th><th>カテゴリー</th><th style={{textAlign:'right'}}>累計時間</th></tr></thead><tbody>
              {tSum.map(t=>{const cat=CATEGORIES.find(c=>c.id===t.category);return(<tr key={t.taskId}><td style={{fontWeight:400}}>{t.name}</td><td>{t.clientName}</td><td>{cat&&<span className={'tag '+cat.color}>{cat.label}</span>}</td><td style={{textAlign:'right',fontFamily:'var(--font-heading)',fontWeight:600}}>{formatTime(t.totalMinutes)}</td></tr>);})}
            </tbody></table>
          </div>
        ) : <div style={{textAlign:'center',color:'var(--text-muted)',padding:'3rem',background:'var(--white)',border:'1px solid var(--border-light)'}}>該当するデータがありません</div>}
      </div>
      <div className="frame-diagonal">
        <div className="ai-chat-container">
          <div style={{position:'absolute',top:'-8px',right:'-8px',width:'28px',height:'28px',border:'1px solid var(--pastel-mint)',opacity:0.5,transform:'rotate(15deg)',pointerEvents:'none',zIndex:2}}></div>
          <div className="principles-label">AI Reflection</div>
          <div className="chat-messages">
            {chatMsgs.length===0&&<div style={{textAlign:'center',color:'var(--text-muted)',fontSize:'0.85rem',padding:'2rem 0'}}>作業データについて質問や内省を始めましょう</div>}
            {chatMsgs.map((m,i)=><div key={i} className={'chat-bubble '+(m.role==='user'?'chat-bubble-user':'chat-bubble-ai')}>{m.content}</div>)}
            {chatLoad&&<div className="chat-bubble chat-bubble-ai" style={{opacity:0.5}}>考えています...</div>}
          </div>
          <div className="chat-input-row"><input className="input" placeholder="質問を入力..." value={chatIn} onChange={e=>setChatIn(e.target.value)} onKeyDown={e=>e.key==='Enter'&&sendChat()} /><button className="btn btn-primary" onClick={sendChat} disabled={chatLoad}>送信</button></div>
        </div>
      </div>
    </div>
  );
}

function DataView({ clients, setClients, tasks, setTasks, timeLogs, setTimeLogs, principles, setPrinciples, clientOrder, setClientOrder, runningState, setRunningState, showToast }) {
  const fRef = useRef(null);
  const handleExport = () => {
    const d={clients,tasks,timeLogs,principles,clientOrder,runningState,exportDate:new Date().toISOString(),version:'v12'};
    const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
    const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download='timevalue-backup-'+new Date().toISOString().split('T')[0]+'.json';a.click();URL.revokeObjectURL(u);
    showToast('データをエクスポートしました');
  };
  const handleImport = (e) => {
    const file=e.target.files?.[0]; if(!file)return;
    const reader=new FileReader();
    reader.onload=(ev)=>{
      try {
        const raw=JSON.parse(ev.target.result);
        const data=migrateImportData(raw);
        if(data.clients)setClients(data.clients);if(data.tasks)setTasks(data.tasks);if(data.timeLogs)setTimeLogs(data.timeLogs);
        if(data.principles)setPrinciples(data.principles);if(data.clientOrder)setClientOrder(data.clientOrder);
        if(data.runningState!==undefined)setRunningState(data.runningState);
        showToast('データをインポートしました');
      } catch(err){console.error(err);showToast('インポートに失敗しました');}
    };
    reader.readAsText(file);if(fRef.current)fRef.current.value='';
  };
  const st={clients:clients.length,tasks:tasks.length,active:tasks.filter(t=>!t.completed).length,logs:timeLogs.length,mins:timeLogs.reduce((s,l)=>s+(l.duration||0),0)};
  return (
    <div className="fade-in">
      <div className="section-header"><h2 className="section-title">Data Management</h2></div>
      <div className="frame-overlap">
        <div className="kpi-grid" style={{marginBottom:'3rem'}}>
          <div className="kpi-card" style={{borderTop:'3px solid var(--pastel-blue)'}}><div className="kpi-label">Clients</div><div className="kpi-value">{st.clients}</div></div>
          <div className="kpi-card" style={{borderTop:'3px solid var(--pastel-purple)'}}><div className="kpi-label">Tasks</div><div className="kpi-value">{st.active}<span className="kpi-unit">/ {st.tasks}</span></div><div className="kpi-sub">アクティブ / 全タスク</div></div>
          <div className="kpi-card" style={{borderTop:'3px solid var(--pastel-mint)'}}><div className="kpi-label">Total Time</div><div className="kpi-value">{formatTime(st.mins)}</div><div className="kpi-sub">{st.logs} ログ</div></div>
        </div>
      </div>
      <div className="frame-diagonal">
        <div className="data-section">
          <div className="data-card"><div className="data-card-title">Export</div><div className="data-card-desc">全データをJSONファイルとしてダウンロード</div><button className="btn btn-primary" onClick={handleExport}>エクスポート</button></div>
          <div className="data-card"><div className="data-card-title">Import</div><div className="data-card-desc">JSONファイルからデータを復元</div><input ref={fRef} type="file" accept=".json" onChange={handleImport} style={{display:'none'}} /><button className="btn" onClick={()=>fRef.current?.click()}>インポート</button></div>
        </div>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
